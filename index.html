<!DOCTYPE html>
<html>
<head>
  <title>Amelaye in minerland Map</title>
  <meta charset="utf-8" />

  <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="css/leaflet.extra-markers.min.css">
  <link rel="stylesheet" href="css/font-awesome/css/fontawesome.min.css">

  <script src="css/font-awesome/js/all.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/rastercoords.js"></script>
  <script src="js/leaflet.extra-markers.min.js"></script>
  <script src="js/geojson.js"></script>
<style>
  #map {
    position: absolute;
    top:0;
    bottom: 0;
    left: 0;
    right: 0;
    width:100%;
    height:100%
  }
</style>
</head>
<body>

<div id="map"></div>

<script>
  ;(function (window) {
    function init (mapid) {
      function layerGeo (map, rc) {
        var layerGeo = L.geoJson(window.geoInfo, {
          // correctly map the geojson coordinates on the image
          coordsToLatLng: function (coords) {
            return rc.unproject(coords)
          },
          // add a popup content to the marker
          onEachFeature: function (feature, layer) {
            if (feature.properties && feature.properties.name) {
              layer.bindPopup(feature.properties.name)
            }
          },
          pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {
              icon: feature.properties.id
            })
          }
        })
        map.addLayer(layerGeo)
        return layerGeo
      }

      function layerBounds (map, rc, img) {
        // set marker at the image bound edges
        var layerBounds = L.layerGroup([
          L.marker(rc.unproject([0, 0])).bindPopup('[0,0]'),
          L.marker(rc.unproject(img)).bindPopup(JSON.stringify(img))
        ])
        map.addLayer(layerBounds)

        // set markers on click events in the map
        map.on('click', function (event) {
          // to obtain raster coordinates from the map use `project`
          var coord = rc.project(event.latlng)
          // to set a marker, ... in raster coordinates in the map use `unproject`
          var marker = L.marker(rc.unproject(coord))
                  .addTo(layerBounds)
          marker.bindPopup('[' + Math.floor(coord.x) + ',' + Math.floor(coord.y) + ']')
                  .openPopup()
        })

        return layerBounds
      }

      var minZoom = 0
      var maxZoom = 9
      var img = [
        38192, // original width of image
        29792  // original height of image
      ]

      // create the map
      var map = L.map(mapid, {
        minZoom: minZoom,
        maxZoom: maxZoom
      })

      var rc = new L.RasterCoords(map, img)
      map.setView(rc.unproject([22000, 15450]), 9)
      L.control.layers({}, {
        //'Bounds': layerBounds(map, rc, img)
        'Info': layerGeo(map, rc)
      }).addTo(map)

      L.tileLayer('./tiles/{z}/{x}/{y}.png', {
        noWrap: true,
        attribution: 'Creation Amelie DUVERNET aka Amelaye <a href="http://minetest.amelieonline.net">Projet Amelaye In Minerland</a>'
      }).addTo(map)
    }

    init('map')
  }(window))

</script>


</body>
</html>